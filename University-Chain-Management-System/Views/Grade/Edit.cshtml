@model GradeViewModel
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["Title"] = "Edit Grade";
}


<form method="post" asp-action="Edit">

    <input type="hidden" asp-for="Grade.Id" />

    <div class="form-group">
        <label asp-for="Grade.Value"></label>
        <select asp-for="Grade.Value"
                class="form-control"
                asp-items="@(new SelectList(new[] { 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0 }))">
        </select>
        <span asp-validation-for="Grade.Value" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Grade.SubjectId">Subject</label>
        <select asp-for="Grade.SubjectId" class="form-control" id="subjectDropdown"
                asp-items="@(new SelectList(Model.Subjects, "Id", "Name"))">
                
        </select>
        <span asp-validation-for="Grade.SubjectId" class="text-danger"></span>
    </div>

    <div class="form-group" id="studentGroup" style="display: none;">
        <label asp-for="Grade.StudentId"></label>
        <select asp-for="Grade.StudentId" id="studentDropdown" class="form-control" placeholder="Student">
            <option value="">Select Student</option>
        </select>
        <span asp-validation-for="Grade.StudentId" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Grade.IssuanceDate"></label>
        <input asp-for="Grade.IssuanceDate" id="datepicker" class="form-control" type="text" placeholder="Issuance Date">
        <span asp-validation-for="Grade.IssuanceDate" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary">Submit</button>
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
</form>

@section Scripts
{
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>

        $(function () {
            $("#datepicker").datepicker({
                dateFormat: "dd/mm/yy"
            });


            $('#subjectDropdown').change(function () {
                loadStudentsForSubject(true);
            });

            loadStudentsForSubject(false);
        });

        function loadStudentsForSubject(subjectChanged = false) {
            var selectedSubjectId = $('#subjectDropdown').val();
            var studentGroup = $('#studentGroup');
            var studentDropdown = $('#studentDropdown');

            var currentStudentId = null;
            if (!subjectChanged) {
                currentStudentId = '@Model.Grade.StudentId';
            }

            if (selectedSubjectId === '' || selectedSubjectId === null) {
                studentGroup.hide();
                studentDropdown.empty().append('<option value="">Select Student</option>');
                return;
            } else {
                studentGroup.show();
                studentDropdown.empty().append('<option value="">Loading...</option>');
            }

            $.ajax({
                url: '@Url.Action("GetAvailableStudents", "Subject")',
                type: 'GET',
                data: {
                    subjectId: selectedSubjectId,
                    currentStudentId: currentStudentId !== '0' && currentStudentId !== '' ? currentStudentId : null
                },
                success: function (students) {
                    studentDropdown.empty();

                    var filledStudent = null;
                    if (currentStudentId && currentStudentId !== '0' && currentStudentId !== '') {
                        filledStudent = students.find(s => s.id == currentStudentId);
                    }

                    if (filledStudent != null) {
                        studentDropdown.append('<option value="' + filledStudent.id + '" selected>' + filledStudent.fullName + '</option>');

                        var studentIndex = students.findIndex(s => s.id == currentStudentId);
                        students.splice(studentIndex, 1);
                    } else {
                        studentDropdown.append('<option value="">Select Student</option>');
                    }

                    $.each(students, function (index, student) {
                        studentDropdown.append('<option value="' + student.id + '">' + student.fullName + '</option>');
                    });
                },
                error: function () {
                    studentDropdown.empty().append('<option value="">Error Loading Students</option>');
                    alert('Error loading available students. Please try again.');
                }
            });
        }
    </script>
}